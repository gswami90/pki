- name: Sleep for a while to give time of any other instances to come up.
  shell: sleep 5s

- name: Install SubCA
  shell: pkispawn -s CA -f /tmp/test_dir/subca.cfg --debug

- name : Stopping SubCA Subsystem
  shell: systemctl stop pki-tomcatd@{{ topology }}-SubCA.service

- name: Enable SignedAudit for Subsystem
  shell: pki-server ca-audit-config-mod -i {{ topology }}-SubCA --logSigning True

- name: Getting certificate nickname for SubCA CS.cfg
  shell: grep "ca.ocsp_signing.nickname" /etc/pki/{{ topology }}-SubCA/ca/CS.cfg |awk -F"=" ' { print $2 } '
  register: nickname_subocsp

- name: Importing client certificate for SubOCSP
  shell: certutil -L -d /var/lib/pki/{{ topology }}-SubCA/alias -n "{{ nickname_subocsp.stdout }}" -a > /tmp/test_dir/subocsp_signing.crt

- name: Starting SubCA Subsystem
  service:
    name: pki-tomcatd@{{ topology }}-SubCA.service
    state: started
